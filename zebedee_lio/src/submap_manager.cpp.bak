#include "zebedee_lio/submap_manager.hpp"

namespace zebedee_lio
{

SubmapManager::SubmapManager(double sliding_window_size, double voxel_leaf_size) 
: sliding_window_size_(sliding_window_size) 
{
  ikd_tree_ = std::make_shared<KD_TREE<PointType>>(voxel_leaf_size);
}

SubmapManager::~SubmapManager() {}

void SubmapManager::updateSlidingWindow(const Eigen::Vector3d& current_position) 
{
  // ðŸš¨ ë””ë²„ê¹…ì„ ìœ„í•´ ë§µ ì‚­ì œ ë¡œì§ì„ ìž„ì‹œë¡œ ì£¼ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
  // ðŸš¨ ì´ë ‡ê²Œ í•˜ë©´ ë§µì´ ê³„ì† ëˆ„ì ë˜ì–´ Odometryê°€ ì •ìƒ ìž‘ë™í•˜ëŠ”ì§€ í™•ì¸í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.
  /*
  sliding_window_box_.vertex_min[0] = current_position.x() - sliding_window_size_;
  sliding_window_box_.vertex_min[1] = current_position.y() - sliding_window_size_;
  sliding_window_box_.vertex_min[2] = current_position.z() - sliding_window_size_;
  sliding_window_box_.vertex_max[0] = current_position.x() + sliding_window_size_;
  sliding_window_box_.vertex_max[1] = current_position.y() + sliding_window_size_;
  sliding_window_box_.vertex_max[2] = current_position.z() + sliding_window_size_;

  points_to_delete_.clear();
  
  // Box_Search í•¨ìˆ˜ê°€ ikd-Treeì˜ ë¹„ê³µê°œ APIì¼ ìˆ˜ ìžˆìœ¼ë¯€ë¡œ,
  // ìš°ì„ ì€ ì‚­ì œ ë¡œì§ ì „ì²´ë¥¼ ë¹„í™œì„±í™”í•˜ì—¬ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.
  // ikd_tree_->Box_Search(sliding_window_box_, points_to_delete_);

  // if (!points_to_delete_.empty()) 
  // {
  //   ikd_tree_->Delete_by_range(&sliding_window_box_, Delete_by_range_function::NOT_RECORD, true);
  // }
  */
 (void)current_position; // ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ë³€ìˆ˜ ê²½ê³ ë¥¼ í”¼í•˜ê¸° ìœ„í•¨
}

void SubmapManager::addPointCloud(const PointCloud::Ptr& cloud_to_add) 
{
  if (cloud_to_add->points.empty()) 
  {
    return;
  }
  ikd_tree_->Build(cloud_to_add->points);
}

PointCloud::Ptr SubmapManager::getSubmap() 
{
  PointCloud::Ptr submap_cloud(new PointCloud());
  // ikd-Treeì˜ flatten í•¨ìˆ˜ëŠ” root ë…¸ë“œ, ì €ìž¥í•  ë²¡í„°, ì €ìž¥ íƒ€ìž…ì„ ì¸ìžë¡œ ë°›ìŠµë‹ˆë‹¤.
  ikd_tree_->flatten(ikd_tree_->Root_Node, submap_cloud->points, NOT_RECORD);
  return submap_cloud;
}

KD_TREE<PointType>::Ptr SubmapManager::getTree() 
{
  return ikd_tree_;
}

} // namespace zebedee_lio